<!DOCTYPE html>

<html>
	<head>
		<meta charset="UTF-8">
		<title>Presenter</title>
		<style type="text/css">
			@font-face
			{
				font-family:'mono';
				src:url('core/UbuntuMono-R.ttf');
			}

			@font-face
			{
				font-family:'fami';
				src:url('core/FAMania2.6.TTF');
			}

			*
			{
				color:#EEEEEE;
				margin:0;
				padding:0;
			}

			::selection
			{
				background:none;
			}

			.input::selection
			{
				background:#CCCCCC;
			}

			body
			{
			}

			a
			{
				color:#CCCCCC;
				font-weight:bold;
			}

			.text
			{
				position:fixed;
				text-align:center;
			}

			.input
			{
				position:absolute;
				border:0;
				background:#444444;
				height:16px;
				padding:4px;
				margin:4px;
				text-align:left;
				font-size:16px;
				font-family:'mono';
				border-radius:2px;
				opacity:.7;
			}

			#inputMain
			{
				left:0px;
				bottom:28px;
			}

			#inputPrint
			{
				bottom:0px;
			}

			#inputHead
			{
				bottom:0px;
			}

			#inputFoot
			{
				bottom:0px;
			}

			#inputColor
			{
				bottom:0px;
			}

			#inputSound
			{
				bottom:0px;
			}

			#inputPage
			{
				width:32px;
				right:-50px;
				bottom:56px;
				text-align:right;
			}

			#inputs
			{
				position:fixed;
				left:0px;
				bottom:-56px;
				width:100%;
			}

			#frame
			{
				position:fixed;
				background:#FFFFFF;
				border:solid 1px #FF0066;
				opacity:0;
				width:1280px;
				height:720px;
			}

			#help
			{
				color:#FFFFFF;
				position:fixed;
				left:-200px;
				top:8px;
				opacity:.3;
				font-family:'mono';
			}

			#command
			{
				position:fixed;
				text-align:center;
				font-size:128px;
				font-family:'fami';
				line-height:1.2;
				color:#FFFFFF;
				opacity:1;
				display:none;
			}

			#commandBg
			{
				position:fixed;
				left:0;
				top:0;
				width:100%;
				height:100%;
				background:#000000;
				opacity:.7;
				display:none;
			}
		</style>
	</head>
	<body>
		<div id="frame"></div>
		<div class="text" id="head"></div>
		<div class="text" id="foot"></div>
		<div class="text" id="main"></div>
		<div id="help">
			E : Edit<br>
			F : Frame<br>
			H : Help<br>
			P : Page<br>
			<br>
			Ctrl + M : New slide<br>
			Ctrl + D : Delete slide<br>
			<br>
			Esc : Command<br>
		</div>
		<div id="inputs">
			<input class="input" id="inputMain" placeholder="Main"></input>
			<input class="input" id="inputPrint" placeholder="Print"></input>
			<input class="input" id="inputHead" placeholder="Head"></input>
			<input class="input" id="inputFoot" placeholder="Foot"></input>
			<input class="input" id="inputColor" placeholder="Color"></input>
			<input class="input" id="inputSound" placeholder="Sound"></input>
			<input class="input" id="inputPage" placeholder="Page"></input>
		</div>
		<audio src="" id="sound"></audio>
		<div id="commandBg"></div>
		<div id="command"></div>
		<script src="core/jquery.js"></script>
		<script src="core/jquery.easing.js"></script>
		<script>

			$(function(){
				var template = {
					main : "",
					head : "",
					foot : "",
					print : "",
					color : "",
					sound : ""
				}

				var data = JSON.parse(localStorage.getItem('presenterData'));
				if(!data){
					data = {
						title : 'Untitled',
						font : '700 64px/1.2 Arial',
						background : '#222',
						slides : [
							$.extend(true,{},template)
						]
					};
				}
				localStorage.setItem('presenterData',JSON.stringify(data));

				function txt(_i){
					var ret=_i;

					while(/#%/.test(ret)){
						ret=ret.replace(/#%/,'<br />');
					}

					while(/#(?!#)([\w,\.\-]+)#(?!#)/.test(ret)){
						var ret=ret.replace(/#(?!#)([\w,\.\-]+)#(?!#)/,function(i){
							var r='';
							i=i.substring(1,i.length-1);
							var a=i.split(',');
							for(var c=0;c<a.length;c++){
								var s=a[c].charAt(0);
								var v=a[c].substring(1);
								if(s=='f'){
									if(v=='b'){v='\'Bebas Neue\'';}
									if(v=='c'){v='\'Comic Sans MS\'';}
									if(v=='r'){v='\'Ricty Diminished\'';}
									r+='font-family:'+v+';';
								}
								if(s=='b'){r+='background:##'+v+';';}
								if(s=='c'){r+='color:##'+v+';';}
								if(s=='s'){r+='font-size:'+v+'px;';}
								if(s=='l'){r+='line-height:'+v+'px;';}
								if(s=='o'){r+='opacity:'+v/100+';';}
								if(s=='B'){r+='font-weight:bold;';}
								if(s=='I'){r+='font-style:italic;';}
								if(s=='N'){r+='font-weight:normal;';}
							}
							r='</span><span style="'+r+'">';
							return r;
						});
					}
					while(/#/.test(ret)){
						ret=ret.replace(/#/,'</span><span>');
					}
					while(/<\/span><span><\/span><span>/.test(ret)){
						ret=ret.replace(/<\/span><span><\/span><span>/,'#');
					}
					return '<span>'+ret+'</span>';
				}

				function colorFunc(_i){
					var ret = _i;
					try{
						if(ret.substring(0,1).toLowerCase() == 'h' && ret.length == 4){
							var h = parseInt(ret.substring(1,2),16);
							var s = parseInt(ret.substring(2,3),16);
							var l = parseInt(ret.substring(3,4),16);
							ret = 'hsl('+h/16*360+','+s/16*100+'%,'+l/16*100+'%)';
						}
						else if(ret.substring(0,1).toLowerCase() == 'h' && ret.length == 7){
							var h = parseInt(ret.substring(1,3),16);
							var s = parseInt(ret.substring(3,5),16);
							var l = parseInt(ret.substring(5,7),16);
							ret = 'hsl('+h/256*360+','+s/256*100+'%,'+l/256*100+'%)';
						}
						else if(ret.toLowerCase() == 'xampanoid'){
							ret = '#FF0066';
						}
					}catch(e){
					}
					return ret;
				}

				var page = 0;
				function turn(_page){
					if(_page<0 || data.slides.length<=_page){return;}
					page = _page;
					console.log(page+1+" / "+data.slides.length+" : "+Math.floor(page/(data.slides.length-1)*100)+" %");
					$('#inputPage').val(page);

					var main = data.slides[page].main;
					var head = data.slides[page].head;
					var foot = data.slides[page].foot;
					var print = data.slides[page].print;
					var color = data.slides[page].color;
					var sound = data.slides[page].sound;

					$('#main').html(txt(main));
					$('#head').html(txt(head));
					$('#foot').html(txt(foot));
					if(print)console.log('%c'+print,'color:#FF0066');
					$('body').css({background:colorFunc(color)});
					$('#sound').remove();
					if(sound){
						$('body').append('<audio id="sound" src="media/'+sound+'" autoplay>');
					}

					$('#inputMain').val(main);
					$('#inputHead').val(head);
					$('#inputFoot').val(foot);
					$('#inputPrint').val(print);
					$('#inputColor').val(color);
					$('#inputSound').val(sound);
					resize();
				}
				turn(0);

				function load(){
					var input = document.createElement('input');
					input.type = 'file';
					input.addEventListener('change',function(_e){
						var reader = new FileReader();
						reader.readAsText(_e.target.files[0]);
						reader.onload = function(_e){
							data = JSON.parse(reader.result);
							turn(0);
						}
					});
					input.click();
				}

				function save(){
					var a = document.createElement('a');
					var blob = new Blob([JSON.stringify(data)],{type:"application/json"});
					var url = URL.createObjectURL(blob);
					a.href = url;
					a.download = ''+data.title+(+new Date())+'.json';
					a.click();
					URL.revokeObjectURL(url);
				}

				function publish(){
					$.get('core/publish.html',function(_data){
						var plusdata = '<json style="display:none">'+enc64(JSON.stringify(data))+'</json>\n'+_data;
						var a = document.createElement('a');
						var blob = new Blob([plusdata],{type:"text/html"});
						var url = URL.createObjectURL(blob);
						a.href = url;
						a.download = ''+data.title+'.html';
						a.click();
						URL.revokeObjectURL(url);
					});

					function enc64(_str){
						return window.btoa(unescape(encodeURIComponent(_str)));
					}
				}

				function shuffle(_a){
					var a = $.extend(true,[],_a);
					for(var i=0; i<a.length; i++){
						var dice = Math.floor(Math.random()*(a.length-i));
						a.push(a.splice(dice,1)[0]);
					}
					return a;
				}

				var inputsIsVisible = false;
				var frameIsVisible = false;
				var helpIsVisible = false;
				var pageIsVisible = false;
				var commandMode = false;
				var command = '';

				function exitCommandMode(){
					commandMode = false;
					command = '';
					$('#command').html(command);
					$('#commandBg').css({display:'none'});
					$('#command').css({display:'none'});
				}

				$(document).on('keydown','body',function(_e){
					var k = _e.keyCode;

					if(k == 27){ // esc
						if(commandMode){
							exitCommandMode();
						}
						else{
							commandMode = true;
							$('#commandBg').css({display:'block'});
							$('#command').css({display:'block'});
						}
						_e.preventDefault();
					}
					else if(commandMode){
						if((48<=k&&k<=57)||(65<=k&&k<=90)){
							command += String.fromCharCode(k);
							$('#command').html(command);
						}
						if(k == 8){
							command = command.substring(0,command.length-1);
							$('#command').html(command);
						}
						if(k == 13){
							if(command == 'NEW'){
								data = {
									title : 'Untitled',
									font : '小塚ゴシック Pro',
									slides : [
										$.extend(true,{},template)
									]
								};
								turn(0);
							}
							if(command == 'LOAD' || command == 'OPEN'){
								load();
							}
							if(command == 'SAVE'){
								save();
							}
							if(command == 'PUBLISH'){
								publish();
							}
							if(command == 'TITLE'){
								var title = prompt('Enter the title',data.title);
								data.title = title;
								localStorage.setItem('presenterData',JSON.stringify(data));
								resize();
							}
							if(command == 'FONT'){
								var font = prompt('Enter the font settings',data.font);
								if(font){data.font = font;}
								localStorage.setItem('presenterData',JSON.stringify(data));
								resize();
							}
							if(command == 'BG' || command == 'BACKGROUND'){
								var background = prompt('Enter the background settings',data.background);
								if(background){data.background = background;}
								localStorage.setItem('presenterData',JSON.stringify(data));
								resize();
							}
							if(command == 'FIRST'){
								turn(0);
							}
							if(command == 'RANDOM'){
								turn(Math.floor(Math.random()*data.slides.length));
							}
							if(command == 'REVERSE'){
								data.slides.reverse();
								turn(page);
							}
							if(command == 'SHUFFLE'){
								data.slides = shuffle(data.slides);
								turn(page);
							}
							if(command == 'TWEET'){
								var a = document.createElement('a');
								a.href = 'https://twitter.com/intent/tweet?text='+encodeURIComponent($('#main').text());
								a.target = '_blank';
								a.click();
							}
							if(command == 'PING'){
								var a = document.createElement('a');
								a.href = 'http://fms-cat.github.io/pong/';
								a.target = '_blank';
								a.click();
							}
							if(command == 'HELP'){
								alert('\
									NEW : Clear all slides\n\
									LOAD : Load slides by json\n\
									SAVE : Save slides as json\n\
									PUBLISH : Save slides for public as html\n\
									TITLE : Change the title\n\
									FONT : Change the default font settings\n\
									BG : Change the default background settings\n\
									FIRST : Jump to first slide\n\
									RANDOM : Jump to random slide\n\
									REVERSE : Reverse order of slides\n\
									SHUFFLE : Shuffle order of slides\n\
									TWEET : Tweet current slide\n\
									PING : Ping\n\
								');
							}

							exitCommandMode();
						}

						_e.preventDefault();
						resize();
					}
					else if(_e.ctrlKey){
						if($(':focus').is('.input')){
							if(k == 37){ // left
								if(_e.shiftKey){data.slides.splice(page-1,2,data.slides[page],data.slides[page-1]);}
								turn(page-1);
								_e.preventDefault();
							}
							if(k == 39){ // right
								if(_e.shiftKey){data.slides.splice(page,2,data.slides[page+1],data.slides[page]);}
								turn(page+1);
								_e.preventDefault();
							}
						}
						if(k == 68){ // d
							if(data.slides.length != 1){
								if(confirm('Delete: Really?')){
									turn(page-1);
									data.slides.splice(page+1,1);
									localStorage.setItem('presenterData',JSON.stringify(data));
									resize();
								}
							}
						}
						if(k == 77){ // m
							data.slides.splice(page+1,0,$.extend(true,{},data.slides[page]));
							turn(page+1);
							localStorage.setItem('presenterData',JSON.stringify(data));
							resize();
						}
					}
					else if(!$(':focus').is('.input')){
						if(k == 37){ // left
							turn(page-1);
						}
						if(k == 39){ // right
							turn(page+1);
						}

						if(k == 69){ // E
							if(inputsIsVisible){
								inputsIsVisible=false;
								$('#inputs').stop().animate({bottom:-56},200,'easeOutCubic');
							}
							else{
								inputsIsVisible=true;
								$('#inputs').stop().animate({bottom:0},200,'easeOutCubic');
							}
						}

						if(k == 70){ // F
							if(frameIsVisible){
								frameIsVisible=false;
								$('#frame').stop().fadeTo(100,0);
							}
							else{
								frameIsVisible=true;
								$('#frame').stop().fadeTo(100,.1);
							}
						}

						if(k == 72){ // H
							if(helpIsVisible){
								helpIsVisible=false;
								$('#help').stop().animate({left:-200},200,'easeOutCubic');
							}
							else{
								helpIsVisible=true;
								$('#help').stop().animate({left:8},200,'easeOutCubic');
							}
						}

						if(k == 80){ // P
							if(pageIsVisible){
								pageIsVisible=false;
								$('#inputPage').stop().animate({right:-50},200,'easeOutCubic');
							}
							else{pageIsVisible=true;
								$('#inputPage').stop().animate({right:0},200,'easeOutCubic');
							}
						}
					}
				});

				$(document).on('keydown keyup change','#inputMain',function(e){
					var main = $('#inputMain').val();
					$('#main').html(txt(main));
					data.slides[page].main = main;
					localStorage.setItem('presenterData',JSON.stringify(data));
					resize();
				});

				$(document).on('keydown keyup change','#inputHead',function(e){
					var head = $('#inputHead').val();
					$('#head').html(txt(head));
					data.slides[page].head = head;
					localStorage.setItem('presenterData',JSON.stringify(data));
					resize();
				});

				$(document).on('keydown keyup change','#inputFoot',function(e){
					var foot = $('#inputFoot').val();
					$('#foot').html(txt(foot));
					data.slides[page].foot = foot;
					localStorage.setItem('presenterData',JSON.stringify(data));
					resize();
				});

				$(document).on('keydown keyup change','#inputPrint',function(e){
					var print = $('#inputPrint').val();
					data.slides[page].print = print;
					localStorage.setItem('presenterData',JSON.stringify(data));
					resize();
				});

				$(document).on('keydown keyup change','#inputColor',function(e){
					var color = $('#inputColor').val();
					$('body').css({background:colorFunc(color)});
					data.slides[page].color = color;
					localStorage.setItem('presenterData',JSON.stringify(data));
					resize();
				});

				$(document).on('keydown keyup change','#inputSound',function(e){
					var sound = $('#inputSound').val();
					data.slides[page].sound = sound;
					localStorage.setItem('presenterData',JSON.stringify(data));
					resize();
				});

				$(document).on('keydown','#inputPage',function(e){
					if(k == 13){
						turn($('#inputPage').val());
					}
				});

				function resize(){
					var W = $(window).width();
					var H = $(window).height();

					$('#main').css({
						left:0,
						top:H/2-$('#main').height()/2,
						width:W
					});

					$('#head').css({
						top:H/2-340,
						left:0,
						width:W
					});

					$('#foot').css({
						bottom:H/2-340,
						left:0,
						width:W
					});

					$('#frame').css({
						left:W/2-640,
						top:H/2-360
					});

					$('#inputMain').css({
						width:W-16,
					});

					$('#inputPrint').css({
						width:W*.5-12,
						left:0
					});

					$('#inputHead').css({
						width:W*.2-12,
						left:W*.5
					});

					$('#inputFoot').css({
						width:W*.2-12,
						left:W*.7
					});

					$('#inputColor').css({
						width:W*.05-12,
						left:W*.9
					});

					$('#inputSound').css({
						width:W*.05-16,
						left:W*.95
					});

					$('#command').css({
						left:0,
						top:H/2-$('#command').height()/2,
						width:W
					});

					$('title').html(data.title);
					$('body').css({'background':data.background});
					$('.text').css({'font':data.font});
				}
				resize();
				window.onresize = resize;
			});
		</script>
	</body>
</html>
